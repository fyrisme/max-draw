(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function e(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=e(o);fetch(o.href,c)}})();class R{constructor(t=0,e=0,s=0,o=1){this.r=t,this.g=e,this.b=s,this.a=o}toString(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}}class L{constructor(t,e){this.x=t,this.y=e}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get norm(){const t=this.length;return t===0?new L(0,0):new L(this.x/t,this.y/t)}sub(t){return new L(this.x-t.x,this.y-t.y)}towards(t,e){const s=t.sub(this).norm;return new L(this.x+s.x*e,this.y+s.y*e)}}function S(i){const t=[...i],e=[];for(;t.length;){const s=t.shift(),o=t.shift();e.push(new L(s,o))}return e}class E{constructor(t=0,e=0,s=0,o=0){this.x=t,this.y=e,this.w=s,this.h=o}}class M{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}includePoint(t,e){t<this.minX&&(this.minX=t),e<this.minY&&(this.minY=e),t>this.maxX&&(this.maxX=t),e>this.maxY&&(this.maxY=e)}includeRect(t){this.includePoint(t.x,t.y),this.includePoint(t.x+t.w,t.y+t.h)}toRect(){return new E(this.minX,this.minY,this.maxX-this.minX,this.maxY-this.minY)}}const T=`
.object .bg { fill : #444; }
.message .bg { fill: url(#messageBg); rx: 4px; }
.fg-stroke { fill: none; stroke: #888; stroke-width: 2; }
.fg-fill { fill: #888; }
.port { fill: #333; stroke: #777; stroke-width: 1; }
.cable { stroke-linecap: round; }
.label {
  font-size: 12px;
  font-family: arial, sans-serif;
  height: 100%;
  display: flex;
  padding: 0 4px;
  flex-direction: column;
  justify-content: center;
  color: #ccc;
  line-height: 1.1;
}
`;function N(i){const t=[];let e=i.shift();if(t.push("M",e.x,e.y),i.length>1){let s=null;for(const o of i){if(!s){s=o;continue}const c=s.towards(e,10),d=s.towards(o,10);t.push("L",c.x,c.y),t.push("Q",s.x,s.y,d.x,d.y),e=s,s=o}s&&t.push("L",s.x,s.y)}else{if(Math.abs(e.x-i[0].x)<5)return t.push("L",i[0].x,i[0].y),t.join(" ");const o=i.shift(),c=(e.y+o.y)/2;t.push("C",e.x,c+20,o.x,c-20,o.x,o.y)}return t.map(s=>typeof s=="number"?s.toFixed(1):s).join(" ")}function z(i,t=!0){const e=Math.random().toString(36).substring(2,15);let s=n=>`clip-${n.id}`;t&&(s=n=>`clip-${n.id}-${e}`);const o=i.calculateBounds().toRect(),c=o.w+i.padding*2,d=o.h+i.padding*2,r=[],$=[];$.push('<linearGradient id="messageBg" x1="0%" y1="0%" x2="0%" y2="100%">','<stop offset="0%" style="stop-color:#555; stop-opacity:1" />','<stop offset="100%" style="stop-color:#333; stop-opacity:1" />',"</linearGradient>");for(const n of i.objects){const{w:p,h:g}=n.rect;$.push(`<mask id="${s(n)}">`,`<rect x="0" y="0" width="${p}" height="${g}" fill="#ffffff"></rect>`,"</mask>")}const w=new Map;for(const n of i.objects){const{x:p,y:g,w:u,h}=n.rect,b=s(n),y=["box","message","number","button","toggle","flonum","inlet","outlet","comment"];let m=`transform="translate(${p.toFixed(1)}, ${g.toFixed(1)})"`;if(y.includes(n.type)||(m+=' opacity="0.5"'),r.push(`<g class="object ${n.type}" ${m}>`),n.type!="comment"&&r.push(`<rect x="0" y="0" width="${u}" height="${h}" class="bg"></rect>`),n.type==="box"){const a=`x="0" width="${u}" height="3" fill="#fff3"`;r.push(`<rect y="0" ${a}></rect>`),r.push(`<rect y="${h-3}" ${a}></rect>`)}let j="";if(["box","message","comment"].includes(n.type)&&(j=n.text),n.type=="number"&&(j="▶︎ 0"),n.type=="flonum"&&(j="▶︎ 0."),y.includes(n.type)||(j=n.type),j&&r.push(`<foreignObject x="0" y="0" width="${u}" height="${h}">`,`<div class="label" xmlns="http://www.w3.org/1999/xhtml"><span>${j}</span></div>`,"</foreignObject>"),n.type==="button"){const l=(u/2).toFixed(1),a=(h/2).toFixed(1);r.push(`<circle cx="${l}" cy="${a}" r="6" class="fg-stroke"></circle>`)}if(n.type==="toggle"){const l=(u/4).toFixed(1),a=(h/4).toFixed(1),f=(u*(3/4)).toFixed(1),x=(h*(3/4)).toFixed(1);r.push(`<line x1="${l}" y1="${a}" x2="${f}" y2="${x}" class="fg-stroke"></line>`,`<line x1="${f}" y1="${a}" x2="${l}" y2="${x}" class="fg-stroke"></line>`)}if(n.type==="inlet"||n.type==="outlet"){const l=u/2,a=h/2,f=6,x=[`${l-f},${a-f}`,`${l+f},${a-f}`,`${l},${a+f}`].map(k=>k.replace(/\.0\b/,"")).join(" ");r.push(`<polygon points="${x}" class="fg-fill"></polygon>`)}const B=10,Y=u-B*2;for(let l=0;l<n.inletCount;l++){const a=B+Y/(n.inletCount-1||1)*l,f=0,x=`${n.id}-i${l}`,k=new L(a+p,f+g);w.set(x,k),r.push(`<circle cx="${a}" cy="${f}" r="3" class="port inlet" id="${x}" mask="url(#${b})"></circle>`)}for(let l=0;l<n.outletCount;l++){const a=B+Y/(n.outletCount-1||1)*l,f=h,x=`${n.id}-o${l}`,k=new L(a+p,f+g);w.set(x,k),r.push(`<circle cx="${a}" cy="${f}" r="3" class="port outlet" id="${x}" mask="url(#${b})"></circle>`)}r.push("</g>")}for(const n of i.lines){const p=n.fromId,g=n.toId,u=w.get(p),h=w.get(g);if(u&&h){const b=[];if(b.push(u),n.midpoints.length>0)for(const m of n.midpoints)b.push(m);b.push(h);const y=N(b);if(n.type=="signal"){let m=n.color?n.color.toString():"#a0f3aB";r.push(`<path d="${y}" fill="none" stroke="${m}"  stroke-width="2" class="cable"></path>`,`<path d="${y}" fill="none" stroke="#000a"  stroke-dasharray="4" stroke-width="2" ></path>`)}else{let m=n.color?n.color.toString():"#aaa";r.push(`<path d="${y}" fill="none" stroke="${m}" stroke-width="2" class="cable"></path>`)}}}return[`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${c} ${d}" width="${c}" height="${d}">`,`<defs>${$.join("")}</defs>`,`<style>${T}</style>`,...r,"</svg>"].join("")}class C{constructor(){this.objects=[],this.lines=[],this.padding=10}calculateBounds(){const t=new M;for(const e of this.objects)t.includeRect(e.rect);for(const e of this.lines)for(const s of e.midpoints)t.includePoint(s.x,s.y);return t}crop(){const e=this.calculateBounds().toRect();for(const s of this.objects)s.rect.x-=e.x-this.padding,s.rect.y-=e.y-this.padding;for(const s of this.lines)for(const o of s.midpoints)o.x-=e.x-this.padding,o.y-=e.y-this.padding}static parse(t){const e=new C,s={boxes:t.boxes??t.patcher?.boxes??[],lines:t.lines??t.patcher?.lines??[]};for(const{box:o}of s.boxes){const[c,d,r,$]=o.patching_rect,w=new E(c,d,r,$);let n=o.maxclass;n==="newobj"&&(n="box");const p={type:n,text:o.text||"",id:o.id,inletCount:o.numinlets||0,outletCount:o.numoutlets||0,outletTypes:o.outlettype||[],rect:w};e.objects.push(p)}for(const o of s.lines||[]){const c=o.patchline;if(c){const{source:d,destination:r,midpoints:$}=c,w=`${d[0]}-o${d[1]}`,n=`${r[0]}-i${r[1]}`,g=e.objects.find(y=>y.id===d[0])?.outletTypes[d[1]]||"",u=$?S($):[];let h;if(c.color){const[y,m,j,X]=c.color;h=new R(y*256,m*256,j*256,X)}const b={fromId:w,toId:n,color:h,midpoints:u,type:g};e.lines.push(b)}}return e}}const D=document.getElementById("open-file"),U=document.getElementById("open-clipboard"),P=document.getElementById("download"),v=document.querySelector(".error");let O=[],I="";function q(){if(!I)return;const i=new Blob([I],{type:"image/svg+xml"}),t=URL.createObjectURL(i),e=document.createElement("a");e.href=t,e.download="patch.svg",e.click(),URL.revokeObjectURL(t)}P?.addEventListener("click",q);function F(i){P?.classList.add("hide");for(const s of O)s.remove();O=[];const t=C.parse(i);t.crop(),I=z(t,!1);const e=document.createElement("div");e.innerHTML=I,document.body.appendChild(e),O.push(e),P?.classList.remove("hide")}D?.addEventListener("click",()=>{const i=document.createElement("input");i.type="file",i.onchange=async t=>{v?.classList.add("hide");try{const e=t.target.files?.[0];if(!e)return;const s=await e.text(),o=JSON.parse(s);F(o)}catch(e){throw v?.classList.remove("hide"),e}},i.click()});U?.addEventListener("click",async()=>{try{v?.classList.add("hide");const i=await navigator.clipboard.readText(),t=JSON.parse(i);F(t)}catch(i){throw v?.classList.remove("hide"),i}});
